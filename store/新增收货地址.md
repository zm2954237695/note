## 新增收货地址

#### 1 新增收货地址-数据表创建

#### 2新增收货地址-创建实体类

#### 3 新增收货地址-持久层

#### 3.1 各功能的开发顺序

当前收货地址功能模块: 列表的展示、修改/删除/设置默认、新增收货地址。开发顺序:新增收货地址-列表展示-设置默认收货地址-删除收货地址-修改收货地址

规划需要执行的SQL语句

##### 1对应的插入语句



```sql
insert into t_address (除了aid外字段列表) values (字段值列表)
```

2.一个用户的收货地址规定最多只能有20条数据对应。在插入用户数据之前先做查询操作。若超过限制则抛出收货地址逻辑控制方面的一个异常.

```sql
select count(*) from t_address where uid=?
```

##### 3.2 接口与抽象方法。

##### 3.3测试

#### 4 新增收货地址-业务层

##### 4.1 规划异常

当用户插入的地址是第一条是，需要将当前地址作为默认的收货地址，如果查询统计总数为0则将当前地址的is_default值设置为1.查询统计的结果为0不代表异常.

查询到的结果大于20,这时候需要抛出业务控制的异常AddressCountLimitException异常.

#### 5 新增收货地址 -控制层

##### 5.1 处理异常

业务层抛出了收货地址总数据超标的异常，在BaseController中进行处理。

```java
else if(e instanceof AddressCountLimitException){
    result.setState(4003);
    result.setMessage("用户的收货地址超出上限的异常");
```

#### 5.2 设计请求

```htt
/address/add_new_address
post
Address address , HttpSession session
JsonResult<Void>
```

#### 5.3 处理请求

在控制层创建AddressController来处理用户收货地址的请求和响应。

### 设置默认地址

#### 1 持久层

##### 1.1 SQL语句规划

1.检测当前用户想设置为默认地址的这条数据是否存在。

```sql
select * from t_address aid = ?
```

2 在修改用户的默认收货地址之前，先将所有的收货地址设为非默认。

```sql
update t_address set is_default=0 where uid = ?
```

3.将用户当前选中的这条记录设置为默认收货地址.

```sql
update t_address set is_default =1 ,modified_fime=?,modified_user=? where aid = ?
```

##### 1.2接口编写

```java
Address findByAid(Integer aid);
Integer updateNonDefault(Integer uid);
Integer updateDefaultByAid(@Param("aid") Integer aid,
                           @Param("modifiedUser") String modifiedUser,
                           @Param("modifiedTime") Date modifiedTime);
```

##### 1.3 xml配置

#### 2业务层

##### 2.1. 规划异常

1. 在执行更新时产生未知的UpdateException异常。已经创建，无需再次编写.

2. 访问的数据不是当前登录用户的收货地址数据，非法访问:AccessDeniedException异常。

3. 收货地址有可能不存在的异常:AddressNotFoundException异常

##### 2.2 设计抽象方法

```java
 void setDefault(Integer aid,Integer uid,String username);
    
```

##### 2.3实现方法

#### 3 控制层

##### 3.1 处理异常

在BaseController类中进行统一的处理。

```java
else if(e instanceof AddressNotFoundException){
    result.setState(4004);
    result.setMessage("用户的收货地址数据不存在的异常");
}else if(e instanceof AccessDeniedException){
    result.setState(4005);
    result.setMessage("收货地址数据非法访问的异常");
```

##### 3.2 设计请求

```http
/addresses/{aid}/set_default
@PathVariable("aid")Interger aid,HttpSession session
JsonResult<Void>
```

##### 3.3 前端页面

### 删除收货地址

#### 1 持久层

##### 1.1 规划需要执行的sql语句

1.在删除之前判断数据是否存在，判断该条地址数据的归属是否是当前的用户。不用重复开发

2.执行删除收货地址的信息。

```sql
delete  from t_address where aid =?
```

3. 如果用户删除的是默认收货地址，将剩下的地址的某一条设置为默认的收货地址。规则可以自定义：最新修改的收货地址设置为默认地址.(modified_time的字段值

```sql
select * from t_address where uid = ? order by modified_time DESC limit 0,1
```

4.如果用户本身就只有一条收货地址的数据，则删除后其他操作不再进行。

##### 1.2 设计抽象方法

在AddressMapper接口中进行抽象方法的设计.

```java
Integer deleteByAid(Integer aid);
Address findLastModified(Integer uid);
```

##### 1.3 映射sql语句

#### 2业务层

##### 2.1 规划异常

在执行删除的时候可能产生未知的删除异常导致数据不能够删除成功。则抛出DeleteException异常。

##### 2.2 设计抽象方法并实现

```java
void delete(Integer aid,Integer uid,String username);
```

##### 2.3 编写测试类

#### 3控制层

1.需要处理的异常DeleteException类

```java
else if (e instanceof  DeleteException){
    result.setState(5002);
    result.setMessage("删除数据时产生未知的异常");
} 
```

2.设计请求

```http
/address/{aid}/delete
POST
```

3.编写请求处理方法的实现。

```java
@RequestMapping("{aid}/delete")
public JsonResult<Void>delete(@PathVariable("aid") Integer aid,
                              HttpSession session){
   addressService.delete(aid,getuidFromSession(session)
           ,getUsernameFromSession(session));

   return new JsonResult<>(OK);
}
```

##### 4 前端页面

