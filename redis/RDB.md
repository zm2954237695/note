##### RDB

bgsave开始时会fork主进程得到子进程(这一步是阻塞的，后面是异步的)，子进程共享主进程的内存数据，完成fork后读取内存数据并写入RDB文件。



![image-20220617100220343](C:\Users\逐梦\AppData\Roaming\Typora\typora-user-images\image-20220617100220343.png)

redis主进程要实现对数据的读写操作，需要在内存中进行操作，但是在Linux系统中所有的进程都不能直接操作物理内存，而是由操作系统给每个进程分配一个虚拟内存，进程对虚拟内存进行操作，同时，<font color=red>操作系统会维护一个虚拟内存和物理内存映射的页表。</font>主进程执行fork命令创建子进程时，仅仅是对主进程的页表进行拷贝。因为映射共享和主进程是一样的，这样就无需拷贝内存的数据，实现内存数据的共享。子进程在执行写入rdb文件时，主进程还能异步执行任务，因为fork采用的是copy-on-write技术，当主进程执行读操作时，访问内存的共享数据；主进程执行写操作时，则会拷贝一份内存的数据，对拷贝的数据进行写操作。

##### 基本流程

- fork主进程得到一个子进程，共享内存空间
- 子进程读取内存数据并写入新的RDB文件
- 用新的RDB文件替换旧的RDB文件

##### RDB的缺点

- fork执行间隔时间长，两次RDB之间写入数据有丢失的风险
- fork子进程、压缩、写出RDB文件都比较耗时











